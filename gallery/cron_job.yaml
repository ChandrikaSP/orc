apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: mybinder-archive-parser
spec:
  # run every day every hour between 6 am and 9 pm (in UTC)
  # don't run it around midnight (UTC), it looks like some events are inserted later
  # and our script starts parsing after last saved event and misses those events which are inserted later
  schedule: "0 6-21 * * *"
  # Setting a limit to 0 corresponds to keeping none of the corresponding kind of jobs after they finish.
  successfulJobsHistoryLimit: 0
  failedJobsHistoryLimit: 70
  jobTemplate:
    spec:
      template:
        metadata:
          name: mybinder-archive-parser
        spec:
          restartPolicy: OnFailure
          nodeSelector:
            base: worker  # where database is
          containers:
          - name: mybinder-archive-parser
            image: gesiscss/binder-gallery:bb7810e
            command: ["flask"]
            args: ["parse-mybinder-archives", "--with-description", "mybinder"]
            ports:
            - containerPort: 5000
              protocol: TCP
            env:
            - name: FLASK_APP
              value:  "binder_gallery"
            - name: FLASK_ENV
              value:  "production"
            - name: BG_BASE_URL
              value:  "/gallery/"
            - name: BG_APPLICATION_SETTINGS
              value:  "gallery_config.Config"
            - name: PRODUCTION_SERVER
              value: "true"
            volumeMounts:
            - name: gallery-config
              mountPath: /binder_gallery/gallery_config.py
              subPath: _secret_config.py
              readOnly: true
          volumes:
          - name: gallery-config
            secret:
              secretName: gallery-config
