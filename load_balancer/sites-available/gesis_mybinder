# http_origin holds the value of Origin request header
# set allowed_origin to http_origin if http_origin/Origin is not empty (default)
# set allowed_origin to "*" if http_origin/Origin is empty
map $http_origin $allowed_origin {
    default $http_origin;
    "" "*";
}

# HTTP server to redirect gesis.mybinder.org 80 traffic to SSL/HTTPS
server {
    listen 80;
    server_name gesis.mybinder.org;
    access_log off;  # turn off access log
    # Tell all requests to port 80 to be 301 (permanently) redirected to HTTPS
    return 301 https://$host$request_uri;
}

# https://webmasters.stackexchange.com/a/60136
# gesis.mybinder.org is a CNAME for notebooks.gesis.org
# HTTPS server for gesis.mybinder.org
# Redirect everything to https://notebooks.gesis.org/binder
server {
    listen 443;
    ssl on;
    server_name gesis.mybinder.org;
    ssl_certificate /etc/letsencrypt/live/gesis.mybinder.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gesis.mybinder.org/privkey.pem;
    include snippets/ssl.conf;

    #include snippets/optimization.conf;
    access_log off;  # turn off access log

    location = /favicon.ico { access_log off; log_not_found off; }

    location / {
        limit_except GET OPTIONS {
            deny  all;
        }
        add_header "Access-Control-Allow-Origin"  *;
        add_header 'Access-Control-Allow-Headers' 'cache-control';
        # no-cache for /health and /versions
        add_header 'Cache-Control' 'no-cache';
        # https://serverfault.com/questions/426673/nginx-redirect-subdomain-to-sub-directory
        # https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#taxing-rewrites
        return 308 https://notebooks.gesis.org/binder$request_uri;
    }

    location /build/ {
        # add OPTIONS for Preflighted requests: https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS
        # adding OPTIONS is just to be safe, I am not sure if this is preflighted
        limit_except GET OPTIONS {
            deny  all;
        }
        # allow all origins if request Origin is empty, otherwise allow only rquest Origin
        add_header Access-Control-Allow-Origin $allowed_origin;
        # to indicate to browsers that server responses can differ based on the value of the Origin request header
        add_header Vary Origin;

        add_header "Access-Control-Allow-Credentials"  "true";
        add_header 'Access-Control-Allow-Headers' 'cache-control';
        add_header 'Content-Type' 'text/event-stream';
        default_type 'text/event-stream';
        add_header 'Cache-Control' 'no-cache';
        # use Permanent Redirect (308) instead of 301, mybinder.org redirects with 307
        return 308 https://notebooks.gesis.org/binder$request_uri;
    }
}
